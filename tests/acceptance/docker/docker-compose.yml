version: '3.8'

services:
  selenium:
    image: seleniarm/standalone-chromium:4.0.0-beta-1-20210215
    ports:
      - 4444:4444
      - 5900:5900
    volumes:
      - /dev/shm:/dev/shm
      - ../filesForUpload:/uploads:ro
    extra_hosts:
      - host.docker.internal:host-gateway

  ocis:
    image: owncloud/ocis:latest
    ports:
      - 9200:9200
    environment:
      OCIS_URL: https://host.docker.internal:9200
      STORAGE_HOME_DRIVER: ocis
      STORAGE_USERS_DRIVER: ocis
      PROXY_OIDC_INSECURE: 'true'
      WEB_UI_CONFIG: /web/config.json
      WEB_ASSET_PATH: /web/dist
      IDP_IDENTIFIER_REGISTRATION_CONF: /web/mac-identifier-registration.yml
      PROXY_ENABLE_BASIC_AUTH: 'true'
      OCIS_LOG_LEVEL: error
    volumes:
      - ../../../dist:/web/dist:ro
      - ../mac-identifier-registration.yml:/web/mac-identifier-registration.yml:ro
      - ./config.ocis.json:/web/config.json:ro
    depends_on:
      - selenium
    extra_hosts:
      - host.docker.internal:host-gateway

  oc10:
    build:
      context: ./
      dockerfile: Dockerfile.oc10
    ports:
      - 8080:8080
    volumes:
      - ./config.oc10.php:/mnt/data/config/setup.config.php:ro
      - ./config.oc10.json:/mnt/data/config/config.json:ro
      - ../../../packages/web-integration-oc10/appinfo:/mnt/data/apps/web/appinfo
      - ../../../packages/web-integration-oc10/lib:/mnt/data/apps/web/lib
      - ../../../dist/css:/mnt/data/apps/web/css
      - ../../../dist/img:/mnt/data/apps/web/img
      - ../../../dist/js:/mnt/data/apps/web/js
      - ../../../dist/themes:/mnt/data/apps/web/themes
      - ../../../dist/index.html:/mnt/data/apps/web/index.html
      - ../../../dist/manifest.json:/mnt/data/apps/web/manifest.json
      - ../../../dist/oidc-callback.html:/mnt/data/apps/web/oidc-callback.html
      - ../../../dist/oidc-silent-redirect.html:/mnt/data/apps/web/oidc-silent-redirect.html
    depends_on:
      - selenium
    extra_hosts:
      - host.docker.internal:host-gateway
